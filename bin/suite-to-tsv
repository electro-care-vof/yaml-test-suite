#!/usr/bin/env perl

use v5.18;
use utf8;
use autodie qw(open close);
use Encode;
use MIME::Base64;
use YAML::PP;

main(@ARGV);

sub main {
  my $ypp = YAML::PP->new;
  my $i = 0;

  print "SKIP\tID\tYAML Input\t1.2 Events\tPlay\tNRP\tORP\tliby\tlibf\tYPP\tNPM\tPYY\tNIM\tHSY\tJSY\tRUA\tDNY\n";

  for my $file (@ARGV) {
    (my $id = $file) =~ s{^.*/(.*)\.yaml$}{$1};

    my $data = $ypp->load_file($file);

    my $test = shift(@$data);

    my $skip = $test->{skip} // '';
    $skip &&= 'X';

    my $yaml = $test->{yaml};
    $yaml =~ s/"/""/g;
    my $tree = $test->{tree};
    $tree =~ s/"/""/g;

    my $play = play_url($test->{yaml});

    my $tsv = encode_utf8 qq{$skip\t$id\t"$yaml"\t"$tree"\t$play\n};

    print $tsv;
  }
}

sub play_url {
  $_ = encode_utf8 shift;

  s/␣/ /g;
  s/—*»/\t/g;
  s/←/\r/g;
  s/⇔/x{FEFF}/g;
  s/↵//g;
  s/∎\n\z//;

  my $base64 = encode_base64($_);
  $base64 =~ s{\n}{}g;
  $base64 =~ s{\+}{-}g;
  $base64 =~ s{/}{_}g;

  return "https://play.yaml.io/main/parser?input=$base64";
}
